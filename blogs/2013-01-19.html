<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<link href='../stylesheets/doc.css' rel='stylesheet' type='text/css' />
<link href='favicon.png' rel='shortcut icon' />
<script type="text/javascript" src="../javascripts/ga.js"></script>
<title>maven项目管理实践指南</title>
</head>

<body>
	<h1>maven项目管理实践指南</h1>
	<span class="date">2013-01-19</span>
	<div class="divider"></div>
	
	<h2>组织工程</h2>
	<p>	
		通常采用多模块（module）组织工程。<br>
		模块划分原则，示例：
	</p>
	<pre><code>
&lt;modules&gt;
    &lt;modules&gt;
    &lt;module&gt;xxx-protocol&lt;/module&gt;  
    &lt;module&gt;xxx-web&lt;/module&gt;
    &lt;module&gt;xxx-config&lt;/module&gt;
&lt;/modules&gt;

1. xxx-protocol 是按功能独立正交性划分 module
2. xxx-web      按部署划分 module，部署为一个 web 应用
3. xxx-config   抽出共享的第三方 module，多个模块需要共享配置
	</code></pre>
	
	
	<h2>依赖管理</h2>
	<p>
		通常统一在父项目中定义所有依赖及其版本，方便以后依赖包的版本升级。<br>
		示例：
	</p>
	<pre><code>
&lt;properties&gt;
    &lt;project.encoding&gt;utf-8&lt;/project.encoding&gt;
    &lt;v.plugin.assembly&gt;2.3&lt;/v.plugin.assembly&gt;
    &lt;v.plugin.compiler&gt;2.5.1&lt;/v.plugin.compiler&gt;
    &lt;v.plugin.resources&gt;2.6&lt;/v.plugin.resources&gt;
    &lt;v.plugin.release&gt;2.4&lt;/v.plugin.release&gt;
    &lt;v.jdk&gt;1.6&lt;/v.jdk&gt;
    &lt;v.junit&gt;4.8.2&lt;/v.junit&gt;
    &lt;v.spring&gt;3.1.2.RELEASE&lt;/v.spring&gt;
&lt;/properties&gt;	
	</code></pre>
	<p>
		如上，统一定义整个项目依赖的 jdk、三方库、 maven 自身依赖插件的版本。<br>
		父 pom
	</p>
	<pre><code>
&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
       &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-beans&lt;/artifactId&gt;
            &lt;version&gt;${v.spring}&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;	
	</code></pre>
	<p>子 pom 中引用，不用指定版本，如下：</p>
	<pre><code>
&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-beans&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;	
	</code></pre>
	<p>有些项目采用在父 pom 中配置所有依赖，子模块继承时所有模块都将依赖所有依赖库，不符合最优最小依赖原则。</p>
	
	
	<h2>发布管理</h2>
	<ol>
		<li>maven 发布 web 类项目</li>
		<p>原生支持 packaging 为 war 包方式，不赘述</p>
		
		<li>maven 发布非 web 类项目</li>
		<p>
			发布为独立 java 进程部署启动。<br>
   			通常采用 maven-assembly-plugin 来打包和组织非 web 类项目。<br>
   			assembly 插件提供了一种比较简单的 jar-with-dependencies 打包方式，将所有三方依赖打入一个大的 jar 中并指定 main 类做成一个可执行 jar 包。<br>
   			这种方式有几个明显的缺点：<br>
   			1）第三方 jar 包抽取冲突，比如 spring 3.x 就不支持这种方式，需要把 spring 3.x 的多个 jar 包抽取到一个中时需要通过其他插件配合进行配置文件合并，比较麻烦<br>
   			2）不便于单独升级第三方 jar 包 <br>
   			<br>
   			这里介绍另外一种方式：<br>
       		1）抽取第三方依赖 jar 包，到独立 lib 目录中<br>
       		2）提取项目配置文件、避免被打入 jar 包中（打入 jar 包中不便于部署和运维时修改）<br>
   			最终打包完成后的目录结构如下：
		</p>
		<pre><code>
   xxxxxxx-version-all/
                      |-- bin/
                             |-- start.sh
                             |-- stop.sh
                      |-- lib/
                             |-- xxx-1.0.2-jar
                      |-- cfg/
                             |-- xx.xml
                             |-- xx.properties
                    
   bin 目录存放启动和停止脚本
   lib 目录存放自身 jar 包和 第三方 jar 包
   cfg 目录存放项目配置文件   		
		</code></pre>
		<p>
		配置示例<br>
   		1）在父 pom 中配置插件管理，如下：
		</p>
		<pre><code>
	&lt;build&gt;
       &lt;pluginManagement&gt;
           &lt;plugins&gt;
                &lt;plugin&gt;
                    &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
                    &lt;version&gt;${v.plugin.jar}&lt;/version&gt;
                    &lt;configuration&gt;
                        &lt;excludes&gt;
                            &lt;exclude&gt;**/*.properties&lt;/exclude&gt;
                            &lt;exclude&gt;**/*.xml&lt;/exclude&gt;
                        &lt;/excludes&gt;
                    &lt;/configuration&gt;
                    &lt;executions&gt;
                        &lt;phase&gt;package&lt;/phase&gt;
                        &lt;goals&gt;                            
                            &lt;goal&gt;jar&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/executions&gt;
                &lt;/plugin&gt;
                &lt;plugin&gt;
                    &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
                    &lt;version&gt;${v.plugin.assembly}&lt;/version&gt;
                    &lt;configuration&gt;
                        &lt;descriptors&gt;
                            &lt;descriptor&gt;
                                src/main/assembly/assembly.xml
                            &lt;/descriptor&gt;
                        &lt;/descriptors&gt;
                    &lt;/configuration&gt;
                    &lt;executions&gt;
                        &lt;phase&gt;package&lt;/phase&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;assembly&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/executions&gt;
                &lt;/plugin&gt;
           &lt;/plugins&gt;
       &lt;/pluginManagement&gt;
   &lt;/build&gt;
		</code></pre>
		<p>2）需要打包部署为独立 java 进程的子模块 pom 中配置引用</p>
		<pre><code>
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
            &lt;plugin&gt;
                &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
		</code></pre>
		<p>3）在 assembly.xml 指定具体的打包方式：</p>
		<pre><code>
    &lt;assembly
        xmlns="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation=
        "http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.0 
         http://maven.apache.org/xsd/assembly-1.1.0.xsd"&gt;
        &lt;id&gt;all&lt;/id&gt;
        &lt;formats&gt;
            &lt;format&gt;dir&lt;/format&gt;  &lt;!-- 其他可选格式 gzip/zip/tar.gz/ --&gt;
        &lt;/formats&gt;
    
        &lt;includeBaseDirectory&gt;false&lt;/includeBaseDirectory&gt;
    
        &lt;dependencySets&gt;
            &lt;dependencySet&gt;
                &lt;outputDirectory&gt;/lib&lt;/outputDirectory&gt;
                &lt;useProjectArtifact&gt;true&lt;/useProjectArtifact&gt;
                &lt;unpack&gt;false&lt;/unpack&gt;
                &lt;scope&gt;runtime&lt;/scope&gt;
            &lt;/dependencySet&gt;
        &lt;/dependencySets&gt;
 
        &lt;fileSets&gt;
            &lt;fileSet&gt;
                &lt;directory&gt;src/main/scripts&lt;/directory&gt;
                &lt;outputDirectory&gt;/bin&lt;/outputDirectory&gt;
            &lt;/fileSet&gt;
            &lt;fileSet&gt;
                &lt;directory&gt;src/main/resources&lt;/directory&gt;
                &lt;outputDirectory&gt;/cfg&lt;/outputDirectory&gt;
            &lt;/fileSet&gt;
        &lt;/fileSets&gt;
    &lt;/assembly&gt;		
		</code></pre>
		
		<li>maven 发布共享库项目</li>
		<p>
			发布一些独立 jar 包给其他项目使用，此类项目的特点是版本迭代快，版本管理复杂，通常采用 maven-release-plugin 来管理发布。<br>
    		maven-release-plugin 典型发布过程如下：<br>
    		1）tag 一个发布版本，并发布到版本管理库（svn或git等）<br>
    		2）更新本地所有模块的 pom 文件中的版本号为下一个指定版本<br>
    		3）部署 tag 出来的发布版本到私有或公共的中央 maven 仓库<br>
    		<br>
    		要完成以上过程，需要在父 pom 做如下的配置：<br>
    		1）maven-release-plugin 插件配置
		</p>
		<pre><code>
    &lt;build&gt;
        &lt;plugins&gt;    
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt;
                &lt;version&gt;${v.plugin.release}&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;!-- tag 发布项目的源码仓库位置 --&gt;
                    &lt;tagBase&gt;http://xxxxxx/tags/xxx&lt;/tagBase&gt;
                    &lt;useReleaseProfile&gt;false&lt;/useReleaseProfile&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
    
    &lt;scm&gt;
        &lt;!-- 待发布项目分支路径 --&gt;
        &lt;developerConnection&gt;scm:svn:http://xxxxxxxx/branches/xxx/&lt;/developerConnection&gt;
    &lt;/scm&gt;
		</code></pre>
		<p>2) 自动部署到 maven 仓库配置</p>
		<pre><code>
    &lt;distributionManagement&gt;
        &lt;snapshotRepository&gt;
            &lt;id&gt;repository.snapshots&lt;/id&gt;
            &lt;name&gt;repository.snapshots&lt;/name&gt;
            &lt;url&gt;http://xxxxxx/libs-snapshots&lt;/url&gt;
        &lt;/snapshotRepository&gt;
        &lt;repository&gt;
            &lt;id&gt;repository.release&lt;/id&gt;
            &lt;name&gt;repository.release&lt;/name&gt;
            &lt;url&gt;http://xxxxxx/libs-releases&lt;/url&gt;
        &lt;/repository&gt;
     &lt;/distributionManagement&gt;
		</code></pre>
		<p>3）在 maven 安装目录下 conf/settings.xml 中配置仓库访问用户名、密码</p>
		<pre><code>
    &lt;servers&gt;
        &lt;server&gt;
            &lt;id&gt;repository.snapshots&lt;/id&gt;
            &lt;username&gt;xxxx&lt;/username&gt;
            &lt;password&gt;*****&lt;/password&gt;
        &lt;/server&gt;
        &lt;server&gt;
            &lt;id&gt;repository.release&lt;/id&gt;
            &lt;username&gt;xxxx&lt;/username&gt;

            &lt;password*****&gt;&lt;/password&gt;

        &lt;/server&gt;
    &lt;/servers&gt;	
		</code></pre>
		<p>4）执行发布，常用发布命令如下：</p>
		<pre><code>
    # 干跑一次，不改变任何东西
      mvn release:prepare -DdryRun=true


    # 如果依赖第三方的 snapshot 包，release 会阻止发布，可以增加选项强制发布
      mvn release:prepare -DignoreSnapshots=true


    # 更新所有模块版本
      mvn release:update-versions


    # 清理，发布中途若出错，可以清理后重新发布
      mvn release:clean


    # 发布准备 交互模式执行
    mvn release:prepare


    # 发布准备 批量模式执行
    mvn --batch-mode release:prepare


    # 发布到远程仓库
    mvn release:perform


    一切配置妥当后，通常只需执行如下两条命令即可完成发布过程
    mvn release:prepare
    mvn release:perform
    
    注意：在一些多模块相互交叉依赖的项目，改变默认的 prepare goal，
    用 intsall 安装最新发布版本到本地库避免 prepare 过程失败 
    mvn release:prepare -DpreparationGoals=clean install		
		</code></pre>
	</ol>
</body>
</html>

